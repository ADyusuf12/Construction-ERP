<%= form_with(model: @employee, local: true, class: "space-y-6 hr-form") do |f| %>
  <% if @employee.errors.any? || (@employee.personal_detail && @employee.personal_detail.errors.any?) %>
    <div class="p-4 rounded bg-hamzis-copper text-hamzis-white">
      <h3 class="font-semibold">
        <%= pluralize(@employee.errors.count + (@employee.personal_detail&.errors&.count || 0), "error") %> prevented saving:
      </h3>
      <ul class="list-disc ml-6 mt-2 text-sm">
        <% (@employee.errors.full_messages + (@employee.personal_detail&.errors&.full_messages || [])).each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- Employment details card -->
    <div class="bg-hamzis-white/30 dark:bg-hamzis-black/30 border rounded-xl p-5 shadow-sm">
      <h4 class="text-sm font-semibold text-hamzis-brown dark:text-hamzis-copper mb-3">Employment</h4>
      <div class="space-y-3">
        <div>
          <%= f.label :user_id, "Link to Hamzis Systems User", class: "block text-xs font-medium text-hamzis-brown dark:text-hamzis-copper" %>
          <%= f.collection_select :user_id,
                User.where(role: [:ceo, :cto, :qs, :site_manager, :engineer, :storekeeper, :hr, :accountant]).where.missing(:employee),
                :id, :email,
                { include_blank: "Select a user to link this employee to" },
                class: "w-full px-3 py-2 border border-hamzis-brown/20 rounded bg-transparent text-gray-900 dark:text-hamzis-copper focus:ring-hamzis-copper focus:border-hamzis-copper" %>
        </div>
        <div>
          <%= f.label :department, class: "block text-xs font-medium text-hamzis-brown dark:text-hamzis-copper" %>
          <%= f.text_field :department, list: "departments", class: "w-full px-3 py-2 border border-hamzis-brown/20 rounded bg-transparent text-gray-900 dark:text-hamzis-copper focus:ring-hamzis-copper" %>
          <datalist id="departments">
            <% @departments.each do |d| %><option value="<%= d %>"></option><% end %>
          </datalist>
        </div>
        <div>
          <%= f.label :position_title, class: "block text-xs font-medium text-hamzis-brown dark:text-hamzis-copper" %>
          <%= f.text_field :position_title, class: "w-full px-3 py-2 border border-hamzis-brown/20 rounded bg-transparent text-gray-900 dark:text-hamzis-copper focus:ring-hamzis-copper" %>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <%= f.label :hire_date, class: "block text-xs font-medium text-hamzis-brown dark:text-hamzis-copper" %>
            <%= f.date_field :hire_date, class: "w-full px-3 py-2 border border-hamzis-brown/20 rounded bg-transparent dark:text-hamzis-copper focus:ring-hamzis-copper" %>
          </div>
          <div>
            <%= f.label :manager_id, "Manager", class: "block text-xs font-medium text-hamzis-brown dark:text-hamzis-copper" %>
            <%= f.select :manager_id, options_for_select([["— No manager —", nil]] + @managers.map { |m| [m.full_name, m.id] }, @employee.manager_id), {}, class: "w-full px-3 py-2 border border-hamzis-brown/20 rounded bg-transparent dark:text-hamzis-copper focus:ring-hamzis-copper" %>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <%= f.label :status, class: "block text-xs font-medium text-hamzis-brown dark:text-hamzis-copper" %>
            <%= f.select :status, options_for_select(@status_options, @employee.status), {}, class: "w-full px-3 py-2 border border-hamzis-brown/20 rounded bg-transparent dark:text-hamzis-copper focus:ring-hamzis-copper" %>
          </div>
          <div>
            <%= f.label :leave_balance, class: "block text-xs font-medium text-hamzis-brown dark:text-hamzis-copper" %>
            <%= f.number_field :leave_balance, value: @employee.leave_balance || 0, class: "w-full px-3 py-2 border border-hamzis-brown/20 rounded bg-transparent dark:text-hamzis-copper focus:ring-hamzis-copper" %>
          </div>
        </div>
      </div>
    </div>
    <!-- Personal details -->
    <%= render "personal_details_fields", f: f %>
    <!-- Next of Kin Section (Stimulus Controller Entry Point) -->
    <div data-controller="nested-form">
      <%= render "next_of_kin_section", f: f %>
    </div>
  </div>
  <!-- Actions -->
  <div class="flex flex-col sm:flex-row gap-3 mt-2">
    <%= f.submit (@employee.persisted? ? "Update Employee" : "Create Employee"),
          class: "px-4 py-2 rounded bg-hamzis-copper text-hamzis-white hover:bg-hamzis-black transition-colors w-full sm:w-auto cursor-pointer font-bold uppercase tracking-wider text-xs" %>
    <%= link_to "Cancel", hr_employees_path,
          class: "px-4 py-2 rounded bg-hamzis-brown text-hamzis-white hover:bg-hamzis-copper transition w-full sm:w-auto text-center text-xs font-bold uppercase tracking-wider" %>
  </div>
<% end %>
