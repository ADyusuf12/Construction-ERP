<%# app/views/layouts/sidebars/_operations_sidebar.html.erb %>
<% if user_signed_in? && (policy(Project).index? || policy(Task).index? || policy(Report).index?) %>
  <div class="space-y-4 py-2">
    <div class="px-3">
      <span class="block text-[10px] font-black uppercase tracking-[0.3em] text-brand-secondary/70 dark:text-white border-b border-brand-secondary/10 dark:border-brand-primary/10 pb-1 mb-2">
        Operations
      </span>
    </div>
    <div class="px-2 space-y-1">
      <%
        # Pre-fetch employee to avoid multiple nil checks
        employee = current_user.employee
        is_field_staff = current_user.role_qs? || current_user.role_engineer?

        # --- TASK LINKS ---
        task_links = []
        # Defensive check: only query if employee exists, otherwise false
        has_active_tasks = employee ? employee.tasks.where.not(status: :done).exists? : false

        if is_field_staff || has_active_tasks
          task_links << { l: 'My Tasks', p: my_tasks_tasks_path }
        end

        if policy(Task).view_global_index?
          task_links << { l: 'All Tasks', p: tasks_path }
        end
        task_links << { l: 'New Task', p: new_task_path, auth: policy(Task).create? }

        # --- REPORT LINKS ---
        report_links = []
        # Defensive check: only query if employee exists
        has_authored_reports = employee ? employee.reports.exists? : false

        if is_field_staff || has_authored_reports
          report_links << { l: 'My Reports', p: my_reports_reports_path }
        end

        if policy(Report).view_global_index?
          report_links << { l: 'All Reports', p: reports_path }
        end
        report_links << { l: 'New Report', p: new_report_path, auth: policy(Report.new).create? }

        # --- CONSOLIDATED ITEMS ---
        items = [
          {
            id: 'projects',
            label: 'Projects',
            icon: 'M3 7h4l2-2h10a2 2 0 012 2v12a2 2 0 01-2 2H5a2 2 0 01-2-2V7z',
            links: [
              { l: 'All Projects', p: projects_path },
              { l: 'New Project', p: new_project_path, auth: policy(Project).create? }
            ]
          },
          {
            id: 'tasks',
            label: 'Tasks',
            icon: 'M9 11l3 3L22 4M4 6h16M4 12h4M4 18h4',
            links: task_links
          },
          {
            id: 'reports',
            label: 'Reports',
            icon: 'M4 6h4v12H4V6zm6 4h4v8h-4v-8zm6-6h4v14h-4V4z',
            links: report_links
          }
        ]
      %>
      <%# Render the Sidebar Groups %>
      <% items.each do |item| %>
        <div class="group">
          <%# Dropdown Toggle Button %>
          <button type="button"
                  class="flex justify-between items-center w-full px-3 py-2.5 rounded-xl border border-transparent hover:bg-brand-secondary/5 dark:hover:bg-brand-primary/5 transition-all duration-300"
                  onclick="document.getElementById('<%= item[:id] %>-dropdown').classList.toggle('hidden')">
            <span class="flex items-center">
              <svg class="w-4 h-4 mr-3 text-brand-secondary/70 dark:text-brand-primary/70 group-hover:text-brand-primary transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="<%= item[:icon] %>" />
              </svg>
              <span class="text-[11px] font-black uppercase tracking-widest text-brand-secondary dark:text-brand-primary">
                <%= item[:label] %>
              </span>
                </span>
                <svg class="w-3 h-3 text-brand-secondary/30 dark:text-brand-primary/30 group-hover:text-brand-primary transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                  <path d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <%# Dropdown Content Links %>
              <div id="<%= item[:id] %>-dropdown" class="ml-9 mt-1 flex flex-col space-y-1 border-l-2 border-brand-secondary/10 dark:border-brand-primary/10 hidden">
                <% item[:links].each do |link| %>
                  <% if link[:auth] != false %>
                    <%= link_to link[:p],
                    class: "flex items-center px-4 py-2 text-[10px] font-bold uppercase tracking-widest transition-all
                    #{current_page?(link[:p]) ?
                      'text-brand-primary border-l-2 border-brand-primary -ml-[2px] bg-brand-primary/5' :
                      'text-brand-secondary/50 dark:text-brand-primary/40 hover:text-brand-secondary dark:hover:text-white hover:bg-brand-secondary/5'}" do %>
                      <%= link[:l] %>
                    <% end %>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>